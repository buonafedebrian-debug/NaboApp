default_platform(:ios)

platform :ios do
  lane :ci do
    # 1) Ensure a new build number (avoids Apple's "duplicate build" rejection)
    increment_build_number(xcodeproj: "ios/App/App.xcodeproj")

    # 2) Build .ipa with automatic signing
    gym(
      workspace: "ios/App/App.xcworkspace",
      scheme: "App",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "build",
      clean: true,
      xcargs: "DEVELOPMENT_TEAM=#{ENV['APPLE_TEAM_ID']}",
      export_options: { signingStyle: "automatic" }
    )

    # 3) Upload to the correct app explicitly
    pilot(
      app_identifier: ENV['APP_IDENTIFIER'],
      skip_waiting_for_build_processing: true,
      distribute_external: false,
      verbose: true
    )
  end
end
