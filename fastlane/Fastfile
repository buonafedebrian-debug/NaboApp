default_platform :ios

platform :ios do
  api_key = app_store_connect_api_key(
    key_id: ENV["ASC_KEY_ID"],
    issuer_id: ENV["ASC_ISSUER_ID"],
    key_content: Base64.decode64(ENV["ASC_KEY_BASE64"]),
    duration: 1200, in_house: false
  )

  desc "Bootstrap signing and build for TestFlight"
  lane :ci_build do
    delete_keychain(name: "build.keychain") rescue nil
    create_keychain(name: "build.keychain", password: "temp_pass", default_keychain: true, unlock: true, timeout: 3600, lock_when_sleeps: false)

    match(
      type: "appstore",
      api_key: api_key,
      readonly: false,
      storage_mode: "git",
      git_url: ENV["MATCH_GIT_URL"],
      git_branch: "main",
      password: ENV["MATCH_PASSWORD"],
      keychain_name: "build.keychain",
      keychain_password: "temp_pass",
      verbose: true
    )

    gym(
      scheme: "App",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "build",
      output_name: "App.ipa",
      clean: true
    )

    pilot(api_key: api_key, ipa: "build/App.ipa", skip_waiting_for_build_processing: true)
  end
end
