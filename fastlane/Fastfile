require 'base64'

default_platform :ios

platform :ios do
  desc "CI build and upload to TestFlight"
  lane :ci_build do
    api_key = app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_content: Base64.decode64(ENV["ASC_KEY_BASE64"]),
      duration: 1200,
      in_house: false
    )

    # Use MATCH_PASSWORD from secrets for keychain password
    keychain_pass = ENV["MATCH_PASSWORD"] || "temp_pass"

    delete_keychain(name: "build.keychain") rescue nil
    create_keychain(
      name: "build.keychain",
      password: keychain_pass,
      default_keychain: true,
      unlock: true,
      timeout: 3600,
      lock_when_sleeps: false
    )

    match(
      type: "appstore",
      app_identifier: ENV["APP_IDENTIFIER"],
      api_key: api_key,
      storage_mode: "git",
      git_url: ENV["MATCH_GIT_URL"],
      git_branch: "main",
      keychain_name: "build.keychain",
      keychain_password: keychain_pass,
      readonly: false,
      verbose: true
    )

    workspace = "ios/App/App.xcworkspace"
    scheme = "App"

    gym(
      workspace: workspace,
      scheme: scheme,
      configuration: "Release",
      export_method: "app-store",
      output_directory: "build",
      output_name: "App.ipa",
      clean: true
    )

    pilot(
      api_key: api_key,
      ipa: "build/App.ipa",
      skip_waiting_for_build_processing: true
    )
  end
end
